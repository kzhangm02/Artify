<html>
	<head>
		<link rel="stylesheet" href="styles.css">
		<script src="https://cdn.jsdelivr.net/npm/@magenta/image@^0.2.1"></script>
	</head>
	<body>
		<div id="myheader" class = "myheader">
			<h1 style="font-weight: bold;"> Artify </h1>
		</div>
		
		<div class="intro-actions">
			<h2> About </h2>
			<span style="font-size: 14px">
				Artify uses arbitrary style transfer to infuse a content image with the style of a famous artwork. <br><br>
				See it in action by uploading an image (or use the sample) and selecting a style!
			</span>
		   <br><br><br>
			<span style="font-size: 12px"> * Uploaded images will be square cropped * </span>
			
			<button class="enabled-btn" id="upload-btn" style="margin-top: 8px; margin-bottom: 20px;" onclick="document.getElementById('upload-file').click();"> Upload Content Image </button>
			<input type="file" id="upload-file" accept="image/*" style="display: none;" />
			<a id="download-container">
				<button class="enabled-btn" id="download-btn"> Download Stylized Image </button>
			</a>
		</div>
		
		<div class="style-selection">
			<h2> Styles </h2>
			<div class="style-container" id="style-container">
			</div>
		</div>
		
		<div class="content-container">
			<div class="content-container-background">
			</div>
			<div class="crop-content-container" id="crop-content-container">
				<img id="content-img" height="360" src="content/content.jpg"/>
			</div>
			<canvas class="stylized-canvas" id="stylized-canvas" height="360" width="360"></canvas>
			<input id="slider-bar" type="range" min="1" max="500" value="250" oninput="slide_img(100 * this.value / this.max, 'bar')">
			<input id="slider-dot" type="range" min="1" max="500" value="250" oninput="slide_img(100 * this.value / this.max, 'dot')">
			<br>
			<div class="status">
				<h3 id="text"> </h3>
			</div>
		</div>
		
		<div class="crop-selected-style-contianer" id="crop-selected-style-container">
			<img id="selected-style-img" src="styles/style1.jpg" height="256" style="display: none;">
		</div>
		
		<script>
			const NUM_STYLES = 6;
			const model = new mi.ArbitraryStyleTransferNetwork();
			const uploadFile = document.getElementById("upload-file");
			const downloadContainer = $("download-container");
			const downloadButton = $("download-btn");
			const contentImg = $("content-img");
			const contentImgContainer = $("crop-content-container");
			const stylizedCanvas = $("stylized-canvas");
			const sliderBar = $("slider-bar");
			const sliderDot = $("slider-dot");
			const text = $("text");
			const styleContainer = $("style-container");
			const selectedStyleImg = $("selected-style-img");
			deactivate_download();
			deactivate_slider();
			
			for (let k = 1; k <= NUM_STYLES; k++) {
				styleContainer.appendChild(createStyle(k));
			}
			
			contentImg.onload = function() {
				var height = this.height;
				var width = this.width;
				if (height <= width) {
					this.style.height = "360px";
					this.style.width = "initial";
				}
				else {
					this.style.height = "initial";
					this.style.width = "360px";
				}
			}
			
			downloadButton.addEventListener("click", function() {
				downloadContainer.href = stylizedCanvas.toDataURL();
				downloadContainer.download = "styledImage.jpg";   
			});
			
			uploadFile.addEventListener("change", function() {
			  changeContentImage(this);
			  deactivate_download();
			  deactivate_slider();
			  deselect_styles();
			});

			function $(x) {
				return document.getElementById(x);
			}
			
			function createStyle(x) {
				var cropStyleContainer = document.createElement("div");
				cropStyleContainer.className = "crop-style-container";
				cropStyleContainer.id = `crop-style-container-${x}`;
				var styleImg = document.createElement("img");
				styleImg.className = "style-img";
				styleImg.id = `style-img${x}`;
				styleImg.src = `styles/style${x}.jpg`;
				styleImg.onclick = function() {select(x)};
				cropStyleContainer.appendChild(styleImg);
				return cropStyleContainer;
			}
			
			function changeContentImage(input) {
				if (input.files && input.files[0]) {
					var reader = new FileReader();
					reader.onload = function(e) {
						contentImg.setAttribute('src', e.target.result);
						text.innerHTML = e.width;
					}
					reader.readAsDataURL(input.files[0]);
					// var fileAsDataURL = window.URL.createObjectURL(input.files[0]);
					// var v = getHeightAndWidthFromDataUrl(fileAsDataURL);
					// text.innerHTML = v;
				}
			}
			
			function stylize() {
				model.stylize(contentImg, selectedStyleImg).then((imageData) => {
					stylizedCanvas.getContext("2d").putImageData(imageData, 0, 0);
				});
				text.innerHTML = "";
			}
			
			function init_stylize() {
				text.innerHTML = "Processing Image...";
				model.initialize().then(stylize).then(activate_download).then(activate_slider);
			}
			
			function select(x) {
				selectedStyleImg.src = `styles/style${x}.jpg`;
				for (let k = 1; k <= NUM_STYLES; k++) {
					if (k != x) {
						$(`crop-style-container-${k}`).className = "crop-style-container";
					}
				}
				$(`crop-style-container-${x}`).className = "crop-style-container-selected";
				init_stylize();
			}
			
			function deselect_styles() {
				for (let k = 1; k <= NUM_STYLES; k++) {
					$(`crop-style-container-${k}`).className = "crop-style-container";
				}
			}
			
			function activate_download() {
				downloadButton.className = "enabled-btn";
				downloadButton.disabled = false;
			}
			
			function deactivate_download() {
				downloadButton.className = "disabled-btn";
				downloadButton.disabled = true;
			}
			
			function activate_slider() {
				sliderBar.style.display = "initial";
				sliderDot.style.display = "initial";
				sliderBar.value = 250;
				sliderDot.value = 250;
				contentImgContainer.setAttribute("style", "width: 50%");
			}
			
			function deactivate_slider() {
				sliderBar.style.display = "none";
				sliderDot.style.display = "none";
				contentImgContainer.setAttribute("style", "width: 100%");
			}
			
			function slide_img(width, type) {
				if (type === "bar") {
					sliderDot.value = sliderBar.value;
				}
				else if (type == "dot") {
					sliderBar.value = sliderDot.value;
				}
				contentImgContainer.setAttribute("style", `width: ${width}%`);
			}
		</script>
	</body>
</html>